# ==============================================================================
# 配置文件
# ==============================================================================

# ==============================================================================
# 业界标准常量 - 通常无需修改
# ==============================================================================
constants:
  # 数据集划分 (机器学习惯例)
  val_split: 0.1                    # 验证集划分比例 (10%)
  test_split: 0.2                   # 测试集划分比例 (20%)

  # 优化器标准参数
  max_grad_norm: 1.0                # 梯度裁剪标准阈值 (防止梯度爆炸)
  sgd_momentum: 0.9                 # SGD 动量标准值 (仅当 optimizer="sgd" 时生效)
  label_smoothing: 0.1              # 标签平滑 (Szegedy et al., 2016)

  # DataLoader 标准配置
  pin_memory: true                  # GPU 训练必开
  persistent_workers: true          # PyTorch 1.7+ 推荐

  # 硬件加速 (现代 GPU 标配)
  use_amp: true                     # 自动混合精度 (使用 BFloat16)
  use_tf32: true                    # TF32 加速 (Ampere+)
  compile_model: true               # PyTorch 2.0+ 编译优化
  seed: 42                          # 随机种子 (复现性标准值)

  # 对抗鲁棒性评估 (Madry et al., 2018; RobustBench)
  adv_eps: 0.03137                  # ε = 8/255 (单值评估时使用)
  adv_alpha: 0.00784                # α = 2/255
  adv_pgd_steps: 10                 # PGD 标准迭代数
  
  # 多 ε 评估 (传入列表即启用多 ε 评估模式)
  # adv_eps_list: [0.00784, 0.01569, 0.03137, 0.06275]  # [2/255, 4/255, 8/255, 16/255]
  adv_eps_list: null                # null = 仅用 adv_eps 单值; 列表 = 多 ε 评估
  
  # 针对性攻击 (targeted attack)
  adv_targeted: false               # true = 针对性攻击 (最小化到目标类); false = 非针对性攻击

  # 校准度评估 (Guo et al., 2017)
  ece_n_bins: 15                    # ECE 分箱数

  # 数据增强标准值
  perlin_persistence: 0.5           # Perlin 噪声标准持久度
  perlin_octaves_large: 4           # Perlin octaves (图像 >= 64 时)
  perlin_octaves_small: 3           # Perlin octaves (图像 < 64 时)

  # 可视化
  plot_dpi: 300                     # 图表保存 DPI

  # Grad-CAM 分析参数
  gradcam_num_samples: 100          # Grad-CAM 分析样本数

# ==============================================================================
# 可调参数
# ==============================================================================
base:
  # ==========================================================================
  # [全局] 数据配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  data_root: "./data"               # 数据集根目录路径
  save_root: "./output"             # 检查点/输出保存根目录
  dataset_name: "cifar10"           # 数据集名称: "cifar10", "cifar100", "eurosat" 等

  # ==========================================================================
  # [全局] 模型配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  model_name: "resnet18"            # 模型名称: "resnet18", "resnet50", "vgg16" 等
  num_models_per_gpu: 3             # 每个 GPU 上的模型数量

  # ==========================================================================
  # [全局] 训练超参数 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  batch_size: 512                   # 批次大小
  lr: 0.0015                        # 基础学习率
  optimizer: "adamw"                # 优化器: "adamw", "sgd", "adam", "rmsprop"
  scheduler: "cosine"               # 调度器: "cosine", "none"
  weight_decay: 0.05                # 权重衰减: AdamW推荐 0.05, SGD推荐 0.0001
  model_level_augmentation: false   # 模型级固定 seed (每个模型固定视角)
  early_stopping_patience: 30       # 早停耐心值 (验证集无改善的轮数)

  # [增强细节调整]
  perlin_scale_ratio: 0.25          # Perlin 噪声尺度比例 (0.2 约产生 2-3 个主要遮挡块)
  gridmask_d_ratio_min: 0.15        # GridMask 最小网格 (更细碎)
  gridmask_d_ratio_max: 0.35        # GridMask 最大网格 (避免单一遮挡)

  # ==========================================================================
  # [阶段训练专用] 三阶段与 Mask - 仅 StagedEnsembleTrainer 使用
  # ==========================================================================
  warmup_epochs: 20                 # Warmup 阶段轮数
  progressive_epochs: 40            # Progressive 阶段轮数
  finetune_epochs: 40               # Finetune 阶段轮数
  mask_pool_size: 1024              # 预生成的 Mask 池大小
  mask_start_ratio: 0.15            # Progressive 阶段起始遮罩比例
  mask_end_ratio: 0.35              # Progressive 阶段结束遮罩比例
  mask_prob_start: 0.30             # Progressive 阶段起始应用概率
  mask_prob_end: 0.70               # Progressive 阶段结束应用概率
  finetune_mask_ratio: 0.25         # Finetune 阶段固定遮罩比例
  finetune_mask_prob: 0.50          # Finetune 阶段固定应用概率

  # ==========================================================================
  # [全局] 数据加载配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  num_workers: 32                   # DataLoader (EPYC 9754: 32 workers)
  prefetch_factor: 8                # 预取队列 (1TB RAM: 激进预取)

  # ==========================================================================
  # [全局] 保存与日志配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  save_every_n_epochs: 20           # 每 N 轮保存一次检查点
  keep_last_n_checkpoints: 2        # 保留最近 N 个检查点
  use_wandb: true                  # 是否启用 Weights & Biases 日志
  wandb_project: "ensemble"         # wandb 项目名称
  log_level: "INFO"                 # 日志级别: "DEBUG", "INFO", "WARNING", "ERROR"
  log_to_console: false              # 训练日志是否输出到控制台 (设为 false 则仅写入文件)

  # ==========================================================================
  # [评估专用] 评估配置 - 仅评估模块使用
  # ==========================================================================
  ensemble_strategy: "mean"         # 集成策略: "mean" (等权平均), "voting" (多数投票)
  corruption_dataset: true          # 是否加载 Corruption 数据集进行评估
  ood_dataset: true                 # 是否加载 OOD 数据集进行评估
  eval_run_gradcam: true            # 是否在评估时运行 Grad-CAM 分析
  eval_run_landscape: true          # 是否在评估时运行 Loss Landscape 分析

  # ==========================================================================
  # [全局] 模型初始化 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  init_method: "kaiming"            # 初始化方法: "kaiming", "xavier", "orthogonal", "default"

  # ==========================================================================
  # [全局] 运行控制 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  quick_test: false                 # 快速测试模式 (减少轮数/模型数)

  # ==========================================================================
  # [实验级别] 增强与课程学习参数 - 每个实验可覆盖
  # ==========================================================================
  augmentation_method: "perlin"     # 增强方法: "perlin", "cutout", "none" 等
  use_curriculum: true              # 是否使用课程学习
  fixed_ratio: 0.25                 # 固定遮挡比例 (仅 use_curriculum=false 时生效)
  fixed_prob: 0.5                   # 固定遮挡概率 (仅 use_curriculum=false 时生效)
  share_warmup_backbone: false       # 是否在 warmup 后共享 backbone (仅 use_curriculum=true 时生效)

# ==============================================================================
# 实验列表
# ==============================================================================
experiments:
  # ============================================================================
  # Perlin 噪声遮挡
  # ============================================================================
  - name: "Exp01_Perlin_Curriculum"
    desc: "Perlin + Curriculum Learning"
    augmentation_method: "perlin"
    use_curriculum: true

  - name: "Exp02_Perlin_Fixed"
    desc: "Perlin + Fixed Ratio"
    augmentation_method: "perlin"
    use_curriculum: false

  # ============================================================================
  # Cutout 硬遮挡
  # ============================================================================
  - name: "Exp03_Cutout_Curriculum"
    desc: "Cutout + Curriculum Learning"
    augmentation_method: "cutout"
    use_curriculum: true

  - name: "Exp04_Cutout_Fixed"
    desc: "Cutout + Fixed Ratio"
    augmentation_method: "cutout"
    use_curriculum: false

  # ============================================================================
  # GridMask 网格遮挡
  # ============================================================================
  - name: "Exp05_GridMask_Curriculum"
    desc: "GridMask + Curriculum Learning"
    augmentation_method: "gridmask"
    use_curriculum: true

  - name: "Exp06_GridMask_Fixed"
    desc: "GridMask + Fixed Ratio"
    augmentation_method: "gridmask"
    use_curriculum: false

  # ============================================================================
  # 像素级 Hide-and-Seek
  # ============================================================================
  - name: "Exp07_PixelHaS_Curriculum"
    desc: "Pixel HaS + Curriculum Learning"
    augmentation_method: "pixel_has"
    use_curriculum: true

  - name: "Exp08_PixelHaS_Fixed"
    desc: "Pixel HaS + Fixed Ratio"
    augmentation_method: "pixel_has"
    use_curriculum: false

  # ============================================================================
  # Baseline (无增强)
  # ============================================================================
  - name: "Exp09_Baseline_Curriculum"
    desc: "No Augmentation + Curriculum Schedule (Control)"
    augmentation_method: "none"
    use_curriculum: true

  - name: "Exp10_Baseline_Fixed"
    desc: "No Augmentation + Fixed Schedule (Pure Baseline)"
    augmentation_method: "none"
    use_curriculum: false


# ==============================================================================
# 评估配置 (仅 --eval 模式)
# ==============================================================================
# 只需修改此时间戳，所有检查点路径自动更新
# 路径格式: ./output/training/{training_timestamp}/{exp_name}/checkpoints/best_acc
training_timestamp: "20260108_161524"  # 修改这里即可

# 实验列表 (路径由代码自动拼接)
eval_checkpoints:
  - "Exp01_Perlin_Curriculum"
  - "Exp02_Perlin_Fixed"
  - "Exp03_Cutout_Curriculum"
  - "Exp04_Cutout_Fixed"
  - "Exp05_GridMask_Curriculum"
  - "Exp06_GridMask_Fixed"
  - "Exp07_PixelHaS_Curriculum"
  - "Exp08_PixelHaS_Fixed"
  - "Exp09_Baseline_Curriculum"
  - "Exp10_Baseline_Fixed"

# ==============================================================================
# 数据生成配置 (generate.py 使用)
# ==============================================================================
generation:
  base_model: "./models/sdxl-base-1.0/sd_xl_base_1.0.safetensors"  # SDXL 基础模型
  lightning_repo: "./models/SDXL-Lightning"              # Lightning UNet 仓库
  lightning_ckpt: "sdxl_lightning_4step_unet.safetensors"  # 4-step UNet 检查点
  num_steps: 4                                             # 推理步数 (2/4/8)
  batch_size: 12                                           # 启用VAE优化后可提高
  samples_per_group: 1000                                  # 每组样本数 (500足够评估)
  visualize: true                                          # 是否生成可视化对比图
  num_vis: 3                                              # 每个类别/风格可视化的样本数

  # SDXL 生成参数
  sdxl_height: 1024                                        # Text2Img 原始输出高度
  sdxl_width: 1024                                         # Text2Img 原始输出宽度
  guidance_scale_text2img: 0.0                             # Text2Img CFG (Lightning 推荐 0)

  # 可视化选项
  vis_corruptions: ["fog"]  # 可视化的 corruption 类型

  # OOD Prompts (CIFAR-10 Near-OOD: 与 10 类相似但不属于它们)
  # CIFAR-10: 飞机/汽车/鸟/猫/鹿/狗/青蛙/马/船/卡车
  ood_prompts:
    # 飞机近似: 直升机、无人机、热气球
    - "helicopter flying in clear blue sky"
    - "drone quadcopter hovering in air"
    - "hot air balloon floating above fields"
    # 汽车近似: 摩托车、公交车、火车
    - "motorcycle parked on street"
    - "city bus at bus stop"
    - "steam locomotive train"
    # 鸟近似: 蝴蝶、蜻蜓、蝙蝠
    - "colorful butterfly on flower"
    - "dragonfly with transparent wings"
    - "bat flying at dusk"
    # 猫/狗近似: 狐狸、狼、豹
    - "red fox in forest"
    - "grey wolf in snow"
    - "leopard resting on tree branch"
    # 鹿/马近似: 斑马、骆驼、羊驼
    - "zebra in african savanna"
    - "camel in desert"
    - "llama in mountain pasture"
    # 青蛙近似: 蟾蜍、蜥蜴、蝾螈
    - "toad sitting on wet rock"
    - "green lizard on tree bark"
    - "salamander near pond"
    # 船近似: 潜艇、游艇、独木舟
    - "submarine surfacing in ocean"
    - "luxury yacht at marina"
    - "kayak on calm lake"
    # 卡车近似: 挖掘机、拖拉机、坦克
    - "excavator on construction site"
    - "red tractor in farm field"
    - "military tank"
