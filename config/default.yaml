# ==============================================================================
# 配置文件
# ==============================================================================

# ==============================================================================
# 业界标准常量 - 通常无需修改
# ==============================================================================
constants:
  # 数据集划分 (机器学习惯例)
  val_split: 0.1                    # 验证集划分比例 (10%)
  test_split: 0.2                   # 测试集划分比例 (20%)

  # 优化器标准参数
  max_grad_norm: 1.0                # 梯度裁剪标准阈值 (防止梯度爆炸)
  sgd_momentum: 0.9                 # SGD 动量标准值 (仅当 optimizer="sgd" 时生效)
  label_smoothing: 0.1              # 标签平滑 (Szegedy et al., 2016)

  # DataLoader 标准配置
  pin_memory: true                  # GPU 训练必开
  persistent_workers: true          # PyTorch 1.7+ 推荐

  # 硬件加速 (现代 GPU 标配)
  use_amp: true                     # 自动混合精度 (使用 BFloat16)
  use_tf32: true                    # TF32 加速 (Ampere+)
  compile_model: true               # PyTorch 2.0+ 编译优化
  seed: 42                          # 随机种子 (复现性标准值)

  # 对抗鲁棒性评估 (Madry et al., 2018; RobustBench)
  adv_eps: 0.03137                  # ε = 8/255
  adv_alpha: 0.00784                # α = 2/255
  adv_pgd_steps: 10                 # PGD 标准迭代数

  # 校准度评估 (Guo et al., 2017)
  ece_n_bins: 15                    # ECE 分箱数

  # 数据增强标准值
  perlin_persistence: 0.5           # Perlin 噪声标准持久度
  perlin_octaves_large: 4           # Perlin octaves (图像 >= 64 时)
  perlin_octaves_small: 3           # Perlin octaves (图像 < 64 时)

  # 可视化
  plot_dpi: 300                     # 图表保存 DPI

# ==============================================================================
# 可调参数
# ==============================================================================
base:
  # ==========================================================================
  # [全局] 数据配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  data_root: "./data"               # 数据集根目录路径
  save_root: "./output"             # 检查点/输出保存根目录
  dataset_name: "cifar10"           # 数据集名称: "cifar10", "cifar100", "eurosat" 等

  # ==========================================================================
  # [全局] 模型配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  model_name: "resnet18"            # 模型名称: "resnet18", "resnet50", "vgg16" 等
  num_models_per_gpu: 3             # 每个 GPU 上的模型数量

  # ==========================================================================
  # [全局] 训练超参数 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  batch_size: 512                   # 批次大小
  lr: 0.0015                        # 基础学习率
  optimizer: "adamw"                # 优化器: "adamw", "sgd", "adam", "rmsprop"
  scheduler: "cosine"               # 调度器: "cosine", "none"
  weight_decay: 0.05                # 权重衰减: AdamW推荐 0.05, SGD推荐 0.0001
  model_level_augmentation: true    # 模型级固定 seed (每个模型固定视角)
  early_stopping_patience: 20       # 早停耐心值 (验证集无改善的轮数)

  # [增强细节调整]
  perlin_scale_ratio: 0.25          # Perlin 噪声尺度比例 (0.2 约产生 2-3 个主要遮挡块)
  gridmask_d_ratio_min: 0.15        # GridMask 最小网格 (更细碎)
  gridmask_d_ratio_max: 0.35        # GridMask 最大网格 (避免单一遮挡)

  # ==========================================================================
  # [阶段训练专用] 三阶段与 Mask - 仅 StagedEnsembleTrainer 使用
  # ==========================================================================
  warmup_epochs: 20                 # Warmup 阶段轮数
  progressive_epochs: 40            # Progressive 阶段轮数
  finetune_epochs: 20               # Finetune 阶段轮数
  mask_pool_size: 1024              # 预生成的 Mask 池大小
  mask_start_ratio: 0.15            # Progressive 阶段起始遮罩比例
  mask_end_ratio: 0.35              # Progressive 阶段结束遮罩比例
  mask_prob_start: 0.30             # Progressive 阶段起始应用概率
  mask_prob_end: 0.70               # Progressive 阶段结束应用概率
  finetune_mask_ratio: 0.25         # Finetune 阶段固定遮罩比例
  finetune_mask_prob: 0.50          # Finetune 阶段固定应用概率

  # ==========================================================================
  # [全局] 数据加载配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  num_workers: 32                   # DataLoader (EPYC 9754: 32 workers)
  prefetch_factor: 8                # 预取队列 (1TB RAM: 激进预取)

  # ==========================================================================
  # [全局] 保存与日志配置 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  save_every_n_epochs: 20           # 每 N 轮保存一次检查点
  keep_last_n_checkpoints: 3        # 保留最近 N 个检查点
  use_tensorboard: true             # 是否启用 TensorBoard 日志
  log_level: "INFO"                 # 日志级别: "DEBUG", "INFO", "WARNING", "ERROR"

  # ==========================================================================
  # [评估专用] 评估配置 - 仅评估模块使用
  # ==========================================================================
  ensemble_strategy: "mean"         # 集成策略: "mean" (等权平均), "voting" (多数投票)
  corruption_dataset: true          # 是否加载 Corruption 数据集进行评估
  ood_dataset: true                 # 是否加载 OOD 数据集进行评估
  domain_dataset: true              # 是否加载 Domain Shift 数据集进行评估

  # ==========================================================================
  # [全局] 模型初始化 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  init_method: "kaiming"            # 初始化方法: "kaiming", "xavier", "orthogonal", "default"

  # ==========================================================================
  # [全局] 运行控制 - 被 StagedEnsembleTrainer 使用
  # ==========================================================================
  quick_test: false                 # 快速测试模式 (减少轮数/模型数)

  # ==========================================================================
  # [实验级别] 增强与课程学习参数 - 每个实验可覆盖
  # ==========================================================================
  augmentation_method: "perlin"     # 增强方法: "perlin", "cutout", "none" 等
  use_curriculum: true              # 是否使用课程学习
  fixed_ratio: 0.25                 # 固定遮挡比例 (仅 use_curriculum=false 时生效)
  fixed_prob: 0.5                   # 固定遮挡概率 (仅 use_curriculum=false 时生效)
  share_warmup_backbone: true       # 是否在 warmup 后共享 backbone (仅 use_curriculum=true 时生效)

# ==============================================================================
# 实验列表
# ==============================================================================
experiments:
  - name: "ExpD_Perlin_Curriculum"
    desc: "Perlin + Dual Curriculum (PROPOSED)"
    augmentation_method: "perlin"
    use_curriculum: true

  - name: "ExpA_Baseline"
    desc: "Baseline (No Augmentation)"
    augmentation_method: "none"
    use_curriculum: false

  - name: "ExpB_Cutout_Fixed"
    desc: "Cutout Fixed (ratio=25%, prob=50%)"
    augmentation_method: "cutout"
    use_curriculum: false
    fixed_ratio: 0.25
    fixed_prob: 0.5

  - name: "ExpC_Perlin_Fixed"
    desc: "Perlin Fixed (ratio=25%, prob=50%)"
    augmentation_method: "perlin"
    use_curriculum: false
    fixed_ratio: 0.25
    fixed_prob: 0.5

  - name: "ExpE_Cutout_Curriculum"
    desc: "Cutout + Dual Curriculum"
    augmentation_method: "cutout"
    use_curriculum: true

# ==============================================================================
# 评估配置 (仅 --eval 模式)
# ==============================================================================
eval_checkpoints:
  - name: "ExpA_Baseline"
    path: "./outputs/exp_latest/checkpoints/ExpA_Baseline/best"

  - name: "ExpB_Cutout_Fixed"
    path: "./outputs/exp_latest/checkpoints/ExpB_Cutout_Fixed/best"

  - name: "ExpC_Perlin_Fixed"
    path: "./outputs/exp_latest/checkpoints/ExpC_Perlin_Fixed/best"

  - name: "ExpD_Perlin_Curriculum"
    path: "./outputs/exp_latest/checkpoints/ExpD_Perlin_Curriculum/best"

  - name: "ExpE_Cutout_Curriculum"
    path: "./outputs/exp_latest/checkpoints/ExpE_Cutout_Curriculum/best"

# ==============================================================================
# 数据生成配置 (generate.py 使用)
# ==============================================================================
generation:
  model_path: "stabilityai/stable-diffusion-2-1"  # SD 模型路径 (本地或 HF ID)
  turbo_model_path: "stabilityai/sdxl-turbo"      # SDXL Turbo 模型路径 (极速模式)
  use_turbo: false                                # 是否默认使用 Turbo 模式
  turbo_steps: 1                                  # Turbo 推理步数 (1-4)
  batch_size: 16                                 # 推理 Batch Size
  samples_per_group: 1000                        # 每组样本数 (Domain/OOD)
  visualize: true                                # 是否生成可视化对比图
  num_vis: 10                                    # 每个类别/风格可视化的样本数

  # Domain Shift 风格与提示词
  styles:
    sketch: "pencil sketch drawing"
    painting: "oil painting artwork"
    cartoon: "cartoon illustration style"
    watercolor: "watercolor painting art"

  # Domain Shift 强度
  strengths: [0.3, 0.5, 0.7]

  # OOD Prompts (Text2Img)
  ood_prompts:
    - "abstract colorful geometric patterns"
    - "underwater coral reef with tropical fish"
    - "close-up of delicious food dishes"
    - "city street at night with neon lights"
    - "cartoon character illustration"
    - "ancient stone ruins in jungle"
    - "microscopic view of cells"
    - "aurora borealis in night sky"
    - "vintage book pages with text"
    - "crystal formations in cave"
